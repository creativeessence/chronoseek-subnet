# Local Development Reference

benefits:
  - free_tao_via_faucet
  - fast_blocks_6_seconds
  - isolated_environment
  - full_chain_control
  - easy_debugging

prerequisites:
  system:
    - docker_and_compose
    - python_3_10_plus
    - ram_8gb_recommended
    - disk_10gb_plus
  
  software: |
    python -m venv .venv
    source .venv/bin/activate
    pip install bittensor bittensor-wallet bittensor-cli

starting_subtensor:
  option_1_docker_compose:
    clone: "git clone https://github.com/opentensor/subtensor.git && cd subtensor"
    start: "docker-compose -f docker-compose.localnet.yml up -d"
    verify: |
      docker ps | grep subtensor
      curl -s -H "Content-Type: application/json" \
        -d '{"jsonrpc":"2.0","method":"chain_getHeader","params":[],"id":1}' \
        http://localhost:9944 | jq .result.number
    stop: "docker-compose -f docker-compose.localnet.yml down"

  option_2_btcli:
    start: "btcli local start"
    stop: "btcli local stop"

  option_3_direct_docker: |
    docker run -d \
      --name subtensor-local \
      -p 9944:9944 \
      -p 9933:9933 \
      opentensor/subtensor-localnet:latest

connection:
  cli: "btcli subnet list --network local"
  sdk: |
    from bittensor import Subtensor
    subtensor = Subtensor(network="local")
    # or: Subtensor(network="ws://127.0.0.1:9944")
    block = subtensor.get_current_block()

wallet_setup:
  create_wallets: |
    # Owner wallet
    btcli wallet new_coldkey --wallet.name owner --n_words 12 --no-password
    btcli wallet new_hotkey --wallet.name owner --wallet.hotkey default
    
    # Miner wallet
    btcli wallet new_coldkey --wallet.name miner --n_words 12 --no-password
    btcli wallet new_hotkey --wallet.name miner --wallet.hotkey default
    
    # Validator wallet
    btcli wallet new_coldkey --wallet.name validator --n_words 12 --no-password
    btcli wallet new_hotkey --wallet.name validator --wallet.hotkey default

  fund_wallets_cli: |
    btcli wallet faucet --wallet.name owner --network local
    btcli wallet faucet --wallet.name miner --network local
    btcli wallet faucet --wallet.name validator --network local

  fund_wallets_sdk: |
    subtensor = Subtensor(network="local")
    wallet = Wallet(name="owner")
    subtensor.faucet(wallet=wallet)
    balance = subtensor.get_balance(wallet.coldkey.ss58_address)

subnet_creation:
  step_1_create: |
    btcli subnet create \
      --wallet.name owner \
      --network local \
      --no-prompt
    
    # SDK:
    success, netuid = subtensor.register_network(wallet=owner)

  step_2_configure: |
    btcli sudo set --netuid 1 --param tempo --value 10 --wallet.name owner --network local
    btcli sudo set --netuid 1 --param max_allowed_uids --value 64 --wallet.name owner --network local

  step_3_register_neurons: |
    btcli subnet register --netuid 1 --wallet.name miner --wallet.hotkey default --network local
    btcli subnet register --netuid 1 --wallet.name validator --wallet.hotkey default --network local

  step_4_stake_validator: |
    btcli stake add --netuid 1 --wallet.name validator --wallet.hotkey default --amount 1000 --network local

local_miner_example: |
  from fastapi import FastAPI, Request
  from bittensor_wallet import Wallet
  from bittensor import Subtensor
  import uvicorn
  
  wallet = Wallet(name="miner")
  subtensor = Subtensor(network="local")
  app = FastAPI()
  
  @app.post("/compute")
  async def compute(request: Request):
      data = await request.json()
      return {"response": f"Echo: {data.get('query', '')}"}
  
  @app.get("/health")
  async def health():
      return {"status": "ok"}
  
  if __name__ == "__main__":
      if not subtensor.is_hotkey_registered(1, wallet.hotkey.ss58_address):
          subtensor.burned_register(wallet=wallet, netuid=1)
      uvicorn.run(app, host="0.0.0.0", port=8091)

local_validator_example: |
  import aiohttp
  from bittensor_wallet import Wallet
  from bittensor import Subtensor, Metagraph
  import asyncio
  
  wallet = Wallet(name="validator")
  subtensor = Subtensor(network="local")
  metagraph = Metagraph(netuid=1, network="local")
  MINER_ENDPOINTS = {}  # hotkey -> url
  
  async def query_miner(url: str, payload: dict) -> dict | None:
      try:
          async with aiohttp.ClientSession() as session:
              async with session.post(url, json=payload, timeout=12) as resp:
                  if resp.status == 200:
                      return await resp.json()
      except Exception:
          pass
      return None
  
  async def validate():
      while True:
          metagraph.sync()
          scores = {}
          
          for uid in range(metagraph.n):
              hotkey = metagraph.hotkeys[uid]
              if hotkey not in MINER_ENDPOINTS:
                  continue
              
              response = await query_miner(f"{MINER_ENDPOINTS[hotkey]}/compute", {"query": "test"})
              scores[uid] = 1.0 if response and response.get("response") else 0.0
          
          if scores:
              uids = list(scores.keys())
              weights = list(scores.values())
              total = sum(weights)
              if total > 0:
                  weights = [w / total for w in weights]
              subtensor.set_weights(wallet=wallet, netuid=1, uids=uids, weights=weights)
          
          await asyncio.sleep(30)
  
  asyncio.run(validate())

debugging:
  metagraph_state: |
    metagraph = Metagraph(netuid=1, network="local")
    metagraph.sync()
    for uid in range(metagraph.n):
        print(f"UID {uid}: {metagraph.hotkeys[uid][:16]}... stake={metagraph.S[uid]} incentive={metagraph.I[uid]}")

  chain_state: |
    btcli subnet show --netuid 1 --network local
    btcli wallet overview --wallet.name miner --network local

  logging: |
    import bittensor as bt
    bt.logging.set_debug()  # or set_trace()

  docker_logs: "docker logs -f subtensor-local"

common_issues:
  connection_refused:
    - "docker ps  # check container running"
    - "netstat -an | grep 9944  # check port"
    - "docker restart subtensor-local"
  
  insufficient_balance:
    - "btcli wallet faucet --wallet.name <name> --network local"
  
  already_registered:
    - "expected if registered before"
    - "use same wallet/hotkey"
  
  no_validators_found:
    - "btcli stake show --network local  # check stake"
    - "inspect metagraph for validator_permit"
  
  slow_blocks:
    - "normal: ~6 seconds per block"
    - "if stuck: restart docker container"

full_test_script: |
  #!/usr/bin/env python3
  import bittensor as bt
  from bittensor_wallet import Wallet
  import asyncio
  
  bt.logging.set_debug()
  
  async def main():
      subtensor = bt.Subtensor(network="local")
      print(f"Connected at block {subtensor.get_current_block()}")
      
      # Setup wallets
      owner = Wallet(name="owner")
      owner.create_if_non_existent()
      miner = Wallet(name="miner")
      miner.create_if_non_existent()
      validator = Wallet(name="validator")
      validator.create_if_non_existent()
      
      # Fund wallets
      for w in [owner, miner, validator]:
          subtensor.faucet(wallet=w)
      
      # Create subnet
      if not subtensor.subnet_exists(netuid=1):
          success, netuid = subtensor.register_network(wallet=owner)
      
      # Register neurons
      for w in [miner, validator]:
          if not subtensor.is_hotkey_registered(1, w.hotkey.ss58_address):
              subtensor.burned_register(wallet=w, netuid=1)
      
      # Stake validator
      subtensor.add_stake(wallet=validator, hotkey_ss58=validator.hotkey.ss58_address, amount=1000)
      
      # Set weights
      metagraph = bt.Metagraph(netuid=1, network="local")
      metagraph.sync()
      miner_uid = metagraph.hotkeys.index(miner.hotkey.ss58_address)
      subtensor.set_weights(wallet=validator, netuid=1, uids=[miner_uid], weights=[1.0])
      
      # Wait for epoch
      await asyncio.sleep(120)
      
      metagraph.sync()
      print(f"Miner incentive: {metagraph.I[miner_uid]}")
  
  asyncio.run(main())
