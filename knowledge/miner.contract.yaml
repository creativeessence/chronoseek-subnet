# Miner Contract Specification

role: producer
primary_function: "provide subnet commodity to earn incentive"

requirements:
  registration: "hotkey registered on subnet"
  endpoint: "discoverable by validators"

responsibilities:
  DO:
    - register_hotkey
    - commit_endpoint_to_chain
    - serve_requests
    - optimize_for_validator_criteria
    - open_source_implementation
  
  DO_NOT:
    - expect_provided_code
    - hide_implementation_from_validators

communication:
  deprecated:
    - axon
    - dendrite
    - synapse
  
  patterns:
    http_api:
      recommended: true
      framework_examples:
        - fastapi
        - flask
      authentication: epistula
      discovery: "commit endpoint to chain"
    
    orchestrator_socket:
      use_when: "no public endpoint needed"
      protocol: socket.io
      example: chutes_model
    
    external_activity:
      use_when: "value from external platforms"
      server_needed: false
      example: github_contributions

endpoint_commitment:
  rate_limit:
    constraint: "1 commitment per 100 blocks (~20 minutes)"
    implication: "commit LOCATION once, not individual items"
  
  what_to_commit:
    - api_urls
    - s3_bucket_urls
    - hippius_bucket_urls
    - database_endpoints
    - model_identifiers
    - docker_image_refs
  
  what_NOT_to_commit:
    - individual_data_CIDs
    - per_request_hashes
    - frequently_changing_values
  
  correct_pattern: |
    # Commit storage location ONCE (or when it changes)
    subtensor.set_commitment(wallet, netuid, "https://s3.hippius.com/my-bucket")
    # Validators pull data directly from this location
  
  incorrect_pattern: |
    # DON'T commit each data item - rate limited!
    for cid in new_cids:
        subtensor.set_commitment(wallet, netuid, cid)  # WRONG
  
  method: "subtensor.set_commitment(wallet, netuid, data)"
  validator_reads: "subtensor.get_all_commitments(netuid)"

architecture_patterns:
  http_api_miner:
    structure:
      - fastapi_app
      - epistula_verification
      - validator_check
      - request_handler
    endpoints:
      required: "defined by validator spec"
      health: "/health"
    
    epistula_verification:
      check_timestamp: "abs(now - ts) < 60s"
      verify_signature: "kp.verify(message, sig)"
      verify_validator: "check metagraph"
  
  orchestrator_miner:
    connection: "socket.io to central"
    auth: "hotkey signature"
    jobs: "execute and return"
    public_endpoint: false
  
  external_activity_miner:
    setup: "register and link identity"
    operation: "perform activity on platform"
    server: "none required"
    monitoring: "check metagraph for incentive"

common_components:
  rate_limiting:
    purpose: "prevent abuse"
    method: "track requests per caller per window"
  
  request_validation:
    - check_required_fields
    - check_field_constraints
    - check_format
  
  logging:
    - request_caller
    - response_time
    - errors

checklist:
  - register_hotkey
  - implement_commodity_provision
  - handle_epistula_verification
  - commit_endpoint_to_chain
  - add_logging
  - test_with_validators
  - open_source_implementation
  - monitor_incentive
