# Pattern: Prediction Market / Simulation
# Example: Synth Subnet

metadata:
  name: prediction_market
  category: forecasting
  examples: ["Synth Subnet"]

when_to_use:
  commodity: "predictions or simulations"
  value_source: "accuracy against future ground truth"
  verification: "delayed (ground truth arrives later)"

architecture:
  miner:
    receives: "prediction request (asset, horizon, parameters)"
    executes: "Monte Carlo simulation (CPU-only, no network)"
    returns:
      format:
        asset: "string (e.g., BTC-USD)"
        horizon: "int (seconds)"
        samples: "list[float] (basis point returns)"
        start_time: "timestamp"
    constraint: "respond before start_time + timeout"
  
  validator:
    phases:
      1_request:
        action: "broadcast prediction requests"
        collect: "responses with timestamps"
      
      2_wait:
        action: "store predictions"
        duration: "until horizon passes"
      
      3_scoring:
        fetch: "actual prices (Pyth Benchmarks)"
        calculate: "CRPS score"
        interpretation: "lower CRPS = better"
    
    aggregation:
      - roll_scores_over_time_windows
      - apply_asset_coefficients
      - softmax_with_negative_beta

crps_scoring:
  name: "Continuous Ranked Probability Score"
  purpose: "measure distribution prediction quality"
  formula: "mean(abs(samples - actual))"
  better: "lower score"
  conversion: "1.0 - min(crps, 1.0)"

anti_gaming:
  start_time_enforcement: "prevents peeking"
  crps_rewards_calibration: "honest distributions"
  rolling_windows: "smooth noise"
  multiple_assets: "prevent overfitting"

timing:
  request: "before prediction window"
  response_deadline: "start_time + timeout"
  scoring: "after horizon elapses"
  ground_truth_source: "external price feed"

open_source_alternative:
  when: "miners build agents with complex decision logic"
  pattern: "miners commit agent code instead of querying"
  validators: "run committed code in sandbox"
  benefit: "transparency, knowledge sharing, constrained attacks"
  reference: "patterns/container_execution.yaml"

selection_criteria:
  use_when:
    - future_events_being_predicted
    - ground_truth_becomes_available
    - distribution_predictions_valuable
  
  dont_use_when:
    - immediate_verification_possible
    - no_clear_ground_truth
    - complex_agent_logic (use containers instead)
