# Validator Contract Specification

role: evaluator
primary_function: "convert miner quality to on-chain weights"

requirements:
  registration: "hotkey registered on subnet"
  stake: "sufficient stake for validator_permit"
  rate_limit: "respect weights_rate_limit"

responsibilities:
  DO:
    - define_clear_scoring_criteria
    - query_or_observe_miners
    - score_responses_deterministically
    - normalize_weights_correctly
    - submit_weights_periodically
    - handle_timeouts_gracefully
    - track_scores_over_time_ema
    - apply_anti_gaming_measures
  
  DO_NOT:
    - write_miner_code
    - implement_reference_solutions
    - hide_evaluation_logic
    - maintain_secret_eval_sets
    - trust_own_ground_truth

design_philosophy:
  validator_only_development:
    rule: "ONLY write validator code. NEVER write miner code."
    rationale:
      - validator_is_referee
      - miners_compete_through_innovation
      - simplicity_breeds_auditability
    
    single_file_pattern:
      file: "validator.py"
      contains:
        - configuration
        - miner_interface_spec
        - discovery_method
        - scoring_logic
        - weight_setting
        - main_loop
      
      excludes:
        - miner_implementation
        - reference_solutions
        - shared_synapse_definitions

core_loop:
  steps:
    1_sync: "metagraph.sync()"
    2_sample: "query miners or check external data"
    3_score: "apply scoring algorithm"
    4_aggregate: "combine into final weights"
    5_set_weights: "submit to chain"
    6_wait: "sleep until next cycle"

communication:
  deprecated:
    - axon
    - dendrite
    - synapse
  
  recommended:
    protocol: "HTTP/REST"
    signing: epistula
    discovery: "miners commit endpoints to chain"
  
  epistula_headers:
    - "X-Epistula-Timestamp": "nonce"
    - "X-Epistula-Signature": "signed(nonce.body_hash)"
    - "X-Epistula-Hotkey": "hotkey_ss58"

scoring_patterns:
  multi_dimensional:
    dimensions:
      - quality
      - speed
      - reliability
      - uniqueness
      - cost_efficiency
    formula: "weighted_sum(dimension_scores)"
  
  relative_vs_baseline:
    formula: "(baseline_error - miner_error) / baseline_error"
  
  tournament:
    formula: "1.0 - (rank / n)"
  
  ema_accumulation:
    formula: "alpha * new_score + (1 - alpha) * old_score"
    age_adjustment: "new miners: higher alpha"

weight_setting:
  normalization: "weights must sum to 1"
  conversion:
    softmax:
      formula: "exp(score/temp) / sum(exp(scores/temp))"
      low_temp: "winner-take-most"
      high_temp: "more equal"
    
    inverse:
      use_when: "lower score is better (CRPS)"
      formula: "softmax with negative beta"
  
  commit_reveal:
    when_to_use: "ONLY if weight copying proven problem"
    warning: "mature subnet problem, not default"
    process:
      1: "commit(hash(weights))"
      2: "wait commit_reveal_period"
      3: "reveal(weights)"

anti_gaming:
  coldkey_deduplication:
    method: "keep only highest-scoring hotkey per coldkey"
    limitation: "NOT sybil-proof (see rules/sybil.realities.yaml)"
  
  rate_gaming_detection:
    method: "check variance of response times"
    suspicious: "very low variance"
